# Progress Log

## 2026-01-19: REQ-1-002 - Install Supabase dependencies

**Completed**: Installed @supabase/supabase-js, @supabase/ssr (runtime deps), supabase CLI (devDep)

**Decisions**:
- Used npm (not pnpm) to match existing project setup

**Files changed**:
- package.json (added dependencies)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-1-003 - Install Framer Motion

**Completed**: Installed framer-motion v12.27.0 for smooth animations

**Files changed**:
- package.json (added framer-motion)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-003 - Create calendar_sources table migration

**Completed**: Created PostgreSQL migration for calendar_sources table

**Decisions**:
- References households(id) and users(id) - requires Phase 1 migrations to run first
- Added CHECK constraint for provider ('google', 'ical')
- Added UNIQUE constraint on (household_id, provider, external_id)
- Added indexes for household lookup and sync queries
- Included encrypted token columns for OAuth security

**Files changed**:
- supabase/migrations/20260119080810_create_calendar_sources.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-004 - Create events table migration

**Completed**: Created PostgreSQL migration for events table

**Decisions**:
- References calendar_sources(id) ON DELETE CASCADE
- UNIQUE constraint on (calendar_source_id, external_id)
- all_day defaults to false
- raw_data stored as JSONB for provider debugging
- updated_at column for tracking modifications

**Files changed**:
- supabase/migrations/20260119090000_create_events.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-005 - Create events table indexes

**Completed**: Created performance indexes for events table

**Decisions**:
- idx_events_calendar_time: composite index on (calendar_source_id, start_time) for calendar queries
- idx_events_time_range: composite index on (start_time, end_time) for date range queries

**Files changed**:
- supabase/migrations/20260119100000_create_events_indexes.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-006 - Create RLS policies for calendar_sources table

**Completed**: Created RLS policies for calendar_sources

**Decisions**:
- Uses get_user_household_id() helper (from Phase 1) for household scoping
- SELECT/INSERT/UPDATE/DELETE all scoped to user's household
- Follows same pattern as Phase 1 RLS policies

**Files changed**:
- supabase/migrations/20260119110000_calendar_sources_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-007 - Create RLS policies for events table

**Completed**: Created RLS policies for events table

**Decisions**:
- Joins through calendar_sources to check household membership
- Uses EXISTS subquery pattern for security
- SELECT/INSERT/UPDATE/DELETE all check calendar_source->household relation
- UPDATE uses both USING and WITH CHECK to prevent changing calendar_source_id to other household

**Files changed**:
- supabase/migrations/20260119120000_events_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-001 - Install Google API dependencies

**Completed**: Installed googleapis v170.1.0 for Google Calendar API access

**Decisions**:
- googleapis includes bundled TypeScript types (no separate @types needed)

**Files changed**:
- package.json (added googleapis)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-009 - Create token encryption utility

**Completed**: Created AES-256-GCM encryption for OAuth tokens

**Decisions**:
- Created lib/crypto.ts (not src/lib) to match existing codebase structure
- Uses Node.js crypto module (no deps needed)
- AES-256-GCM with scrypt key derivation
- Random salt + IV per encryption for security
- Base64 encoding for storage: salt + iv + authTag + ciphertext
- Requires ENCRYPTION_KEY env var

**Files changed**:
- lib/crypto.ts (new)
- lib/crypto.test.ts (new)

**Verification**:
- typecheck: pass
- test: pass (11 tests)
- lint: pass

## 2026-01-19: REQ-2-002 - Add Google OAuth environment variables

**Completed**: Created .env.local.example with Google OAuth credentials

**Decisions**:
- Created .env.local.example (not .env.example) to follow Next.js conventions
- Added exception to .gitignore for .env.local.example
- Documented Google Calendar setup in README

**Files changed**:
- .env.local.example (new)
- README.md (added env var docs)
- .gitignore (added exception for .env.local.example)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-008 - Create Google OAuth utility module

**Completed**: Created OAuth2 client utility for Google Calendar API

**Decisions**:
- Created lib/google/auth.ts (matches existing lib/ pattern, not src/lib/ from PRD)
- Uses google-auth-library (from googleapis package)
- Exports: createOAuth2Client, createOAuth2ClientWithTokens, generateAuthUrl, exchangeCodeForTokens, refreshAccessToken, checkTokenStatus, getValidOAuth2Client
- 5-minute buffer for token expiry checks
- getValidOAuth2Client auto-refreshes and calls onTokenRefresh callback

**Files changed**:
- lib/google/auth.ts (new)
- lib/google/auth.test.ts (new)

**Verification**:
- typecheck: pass
- test: pass (16 tests)
- lint: pass

## 2026-01-19: REQ-2-010 - Create Google OAuth initiation route

**Completed**: Created API route to start Google Calendar OAuth flow

**Decisions**:
- Created lib/supabase/server.ts as prerequisite (Phase 1 client utility)
- Route at app/api/google/auth/route.ts (not src/app as PRD - matching codebase pattern)
- CSRF state format: userId:randomToken for verification in callback
- Scopes: calendar.readonly + calendar.events.readonly
- Redirects to Google consent page (302 redirect)

**Files changed**:
- lib/supabase/server.ts (new)
- app/api/google/auth/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-011 - Create Google OAuth callback route

**Completed**: Created API route to handle Google OAuth callback

**Decisions**:
- Route at app/api/google/callback/route.ts (matching existing pattern)
- Validates CSRF state (userId:randomToken format)
- Exchanges code for tokens via existing auth utility
- Encrypts access + refresh tokens before storage
- Fetches Google Calendar list and stores all calendars (enabled=false)
- Uses upsert to handle reconnection scenarios
- Redirects to /calendars/connect for calendar selection
- Error redirects to /calendars?error={type}

**Files changed**:
- app/api/google/callback/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-014 + REQ-2-015 - Create Google Calendar sync utility

**Completed**: Created calendar sync utility with event upsert function

**Decisions**:
- lib/google/calendar.ts exports: mapGoogleEventToDbEvent, upsertEvents, deleteEvents, syncCalendarEvents
- Uses syncToken for incremental sync, falls back to full sync on 410 error
- Time range for full sync: 30 days ago to 90 days ahead
- singleEvents=true expands recurring events into instances (REQ-2-036)
- Handles pagination (maxResults=250 per page)
- Cancelled events deleted from DB (status='cancelled')
- Auto-refreshes tokens via getValidOAuth2Client callback
- Updates sync_token + last_synced_at after successful sync

**Files changed**:
- lib/google/calendar.ts (new)
- lib/google/calendar.test.ts (new, 9 tests)

**Verification**:
- typecheck: pass
- test: pass (38 tests total)
- lint: pass