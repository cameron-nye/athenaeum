# Progress Log

## 2026-01-19: REQ-1-002 - Install Supabase dependencies

**Completed**: Installed @supabase/supabase-js, @supabase/ssr (runtime deps), supabase CLI (devDep)

**Decisions**:
- Used npm (not pnpm) to match existing project setup

**Files changed**:
- package.json (added dependencies)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-1-003 - Install Framer Motion

**Completed**: Installed framer-motion v12.27.0 for smooth animations

**Files changed**:
- package.json (added framer-motion)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-003 - Create calendar_sources table migration

**Completed**: Created PostgreSQL migration for calendar_sources table

**Decisions**:
- References households(id) and users(id) - requires Phase 1 migrations to run first
- Added CHECK constraint for provider ('google', 'ical')
- Added UNIQUE constraint on (household_id, provider, external_id)
- Added indexes for household lookup and sync queries
- Included encrypted token columns for OAuth security

**Files changed**:
- supabase/migrations/20260119080810_create_calendar_sources.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-004 - Create events table migration

**Completed**: Created PostgreSQL migration for events table

**Decisions**:
- References calendar_sources(id) ON DELETE CASCADE
- UNIQUE constraint on (calendar_source_id, external_id)
- all_day defaults to false
- raw_data stored as JSONB for provider debugging
- updated_at column for tracking modifications

**Files changed**:
- supabase/migrations/20260119090000_create_events.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-005 - Create events table indexes

**Completed**: Created performance indexes for events table

**Decisions**:
- idx_events_calendar_time: composite index on (calendar_source_id, start_time) for calendar queries
- idx_events_time_range: composite index on (start_time, end_time) for date range queries

**Files changed**:
- supabase/migrations/20260119100000_create_events_indexes.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-006 - Create RLS policies for calendar_sources table

**Completed**: Created RLS policies for calendar_sources

**Decisions**:
- Uses get_user_household_id() helper (from Phase 1) for household scoping
- SELECT/INSERT/UPDATE/DELETE all scoped to user's household
- Follows same pattern as Phase 1 RLS policies

**Files changed**:
- supabase/migrations/20260119110000_calendar_sources_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-007 - Create RLS policies for events table

**Completed**: Created RLS policies for events table

**Decisions**:
- Joins through calendar_sources to check household membership
- Uses EXISTS subquery pattern for security
- SELECT/INSERT/UPDATE/DELETE all check calendar_source->household relation
- UPDATE uses both USING and WITH CHECK to prevent changing calendar_source_id to other household

**Files changed**:
- supabase/migrations/20260119120000_events_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-001 - Install Google API dependencies

**Completed**: Installed googleapis v170.1.0 for Google Calendar API access

**Decisions**:
- googleapis includes bundled TypeScript types (no separate @types needed)

**Files changed**:
- package.json (added googleapis)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-009 - Create token encryption utility

**Completed**: Created AES-256-GCM encryption for OAuth tokens

**Decisions**:
- Created lib/crypto.ts (not src/lib) to match existing codebase structure
- Uses Node.js crypto module (no deps needed)
- AES-256-GCM with scrypt key derivation
- Random salt + IV per encryption for security
- Base64 encoding for storage: salt + iv + authTag + ciphertext
- Requires ENCRYPTION_KEY env var

**Files changed**:
- lib/crypto.ts (new)
- lib/crypto.test.ts (new)

**Verification**:
- typecheck: pass
- test: pass (11 tests)
- lint: pass

## 2026-01-19: REQ-2-002 - Add Google OAuth environment variables

**Completed**: Created .env.local.example with Google OAuth credentials

**Decisions**:
- Created .env.local.example (not .env.example) to follow Next.js conventions
- Added exception to .gitignore for .env.local.example
- Documented Google Calendar setup in README

**Files changed**:
- .env.local.example (new)
- README.md (added env var docs)
- .gitignore (added exception for .env.local.example)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-008 - Create Google OAuth utility module

**Completed**: Created OAuth2 client utility for Google Calendar API

**Decisions**:
- Created lib/google/auth.ts (matches existing lib/ pattern, not src/lib/ from PRD)
- Uses google-auth-library (from googleapis package)
- Exports: createOAuth2Client, createOAuth2ClientWithTokens, generateAuthUrl, exchangeCodeForTokens, refreshAccessToken, checkTokenStatus, getValidOAuth2Client
- 5-minute buffer for token expiry checks
- getValidOAuth2Client auto-refreshes and calls onTokenRefresh callback

**Files changed**:
- lib/google/auth.ts (new)
- lib/google/auth.test.ts (new)

**Verification**:
- typecheck: pass
- test: pass (16 tests)
- lint: pass

## 2026-01-19: REQ-2-010 - Create Google OAuth initiation route

**Completed**: Created API route to start Google Calendar OAuth flow

**Decisions**:
- Created lib/supabase/server.ts as prerequisite (Phase 1 client utility)
- Route at app/api/google/auth/route.ts (not src/app as PRD - matching codebase pattern)
- CSRF state format: userId:randomToken for verification in callback
- Scopes: calendar.readonly + calendar.events.readonly
- Redirects to Google consent page (302 redirect)

**Files changed**:
- lib/supabase/server.ts (new)
- app/api/google/auth/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-011 - Create Google OAuth callback route

**Completed**: Created API route to handle Google OAuth callback

**Decisions**:
- Route at app/api/google/callback/route.ts (matching existing pattern)
- Validates CSRF state (userId:randomToken format)
- Exchanges code for tokens via existing auth utility
- Encrypts access + refresh tokens before storage
- Fetches Google Calendar list and stores all calendars (enabled=false)
- Uses upsert to handle reconnection scenarios
- Redirects to /calendars/connect for calendar selection
- Error redirects to /calendars?error={type}

**Files changed**:
- app/api/google/callback/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-014 + REQ-2-015 - Create Google Calendar sync utility

**Completed**: Created calendar sync utility with event upsert function

**Decisions**:
- lib/google/calendar.ts exports: mapGoogleEventToDbEvent, upsertEvents, deleteEvents, syncCalendarEvents
- Uses syncToken for incremental sync, falls back to full sync on 410 error
- Time range for full sync: 30 days ago to 90 days ahead
- singleEvents=true expands recurring events into instances (REQ-2-036)
- Handles pagination (maxResults=250 per page)
- Cancelled events deleted from DB (status='cancelled')
- Auto-refreshes tokens via getValidOAuth2Client callback
- Updates sync_token + last_synced_at after successful sync

**Files changed**:
- lib/google/calendar.ts (new)
- lib/google/calendar.test.ts (new, 9 tests)

**Verification**:
- typecheck: pass
- test: pass (38 tests total)
- lint: pass

## 2026-01-19: REQ-2-016 - Create manual sync trigger API

**Completed**: Created API route to manually trigger calendar sync

**Decisions**:
- Route at app/api/calendars/sync/route.ts
- POST accepts { calendar_source_id } in body
- Validates user auth + household membership via RLS-like check
- In-memory rate limiting: 5 requests per calendar per minute
- Returns { success, events_upserted, events_deleted, error? }
- HTTP 401 (unauth), 400 (bad request), 404 (not found), 429 (rate limited), 500 (sync failed)

**Files changed**:
- app/api/calendars/sync/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-017 - Create cron sync API route

**Completed**: Created Vercel cron endpoint for background calendar sync

**Decisions**:
- Route at app/api/cron/sync/route.ts
- GET handler validates CRON_SECRET via Authorization header
- Added createAdminClient() to lib/supabase/server.ts for RLS bypass
- Queries enabled google calendar_sources not synced in 5 min
- Syncs all stale calendars in parallel via Promise.all
- Returns { calendars_synced, total_events_upserted, total_events_deleted, failures }
- Partial failures handled gracefully (continues other syncs)

**Files changed**:
- lib/supabase/server.ts (added createAdminClient)
- app/api/cron/sync/route.ts (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-018 - Create vercel.json with cron configuration

**Completed**: Created Vercel cron config for background sync

**Decisions**:
- Schedule: */5 * * * * (every 5 minutes)
- Path: /api/cron/sync (matches existing route)

**Files changed**:
- vercel.json (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-033 - Create date utility functions

**Completed**: Created comprehensive date utilities for calendar views

**Decisions**:
- Created lib/utils/dates.ts (matches existing lib/ pattern, not src/lib/)
- All calculations use UTC for consistency
- Timezone param optional on display functions (uses local by default)
- Week starts on Sunday (US standard)
- getMonthCalendarDates returns 42 dates (6 weeks) for grid display
- parseISO for consistent ISO string parsing

**Functions created**:
- getStartOfWeek, getEndOfWeek - week boundaries
- getStartOfMonth, getEndOfMonth - month boundaries
- getStartOfDay, getEndOfDay - day boundaries
- isToday, isSameDay, isSameMonth - date comparisons
- getEventDurationMinutes, getEventDurationHours - duration calc
- formatDate, formatFullDate, formatShortDate, formatTime, formatDateTime, formatMonthYear, formatDayOfWeek - display formatting
- addDays, addWeeks, addMonths - date arithmetic
- getDaysInMonth, getMonthCalendarDates, getWeekDates, getDayHours - calendar grid helpers
- formatEventDuration - human-readable duration
- parseISO, getNow - date creation
- isMultiDayEvent, isWithinRange, doRangesOverlap - range utilities

**Files changed**:
- lib/utils/dates.ts (new)
- lib/utils/dates.test.ts (new, 52 tests)

**Verification**:
- typecheck: pass
- test: pass (90 tests total)
- lint: pass

## 2026-01-19: REQ-2-019 - Add CRON_SECRET environment variable

**Completed**: Added CRON_SECRET to env example and docs

**Files changed**:
- .env.local.example (added CRON_SECRET)
- README.md (added to env vars table)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-020 - Create calendar view data fetching

**Completed**: Created server-side functions to fetch events for calendar views

**Decisions**:
- Created lib/calendar/queries.ts (matches existing lib/ pattern)
- fetchEventsForDateRange: joins events with calendar_sources, filters by enabled=true
- Uses overlapping range query (start < rangeEnd AND end > rangeStart)
- Returns denormalized CalendarViewEvent type with calendar_source info
- fetchEnabledCalendarSources + fetchAllCalendarSources for calendar list views
- RLS handles household scoping automatically

**Files changed**:
- lib/calendar/queries.ts (new)
- lib/calendar/queries.test.ts (new, 13 tests)
- docs/prd.json (marked 19 requirements as completed)

**Verification**:
- typecheck: pass
- test: pass (103 tests total)
- lint: pass

## 2026-01-19: REQ-2-034 - Timezone handling (already implemented)

**Completed**: Already implemented in date utilities and calendar sync

**Notes**:
- Events stored in UTC via toISOString() in mapGoogleEventToDbEvent
- formatDate/formatTime accept timezone param, default to local
- All-day events stored as midnight UTC with all_day flag
- raw_data preserves original Google event with timezone info

**Files**: No changes needed (lib/utils/dates.ts, lib/google/calendar.ts already handle this)

## 2026-01-19: REQ-2-036 - Recurring events (already implemented)

**Completed**: Already implemented in calendar sync utility

**Notes**:
- singleEvents=true in fetchGoogleEvents expands recurring events
- Individual instances stored in events table
- recurrence_rule stored for display
- Exception handling done by Google API (singleEvents mode)

## 2026-01-19: REQ-2-021 - Create month calendar view component

**Completed**: Created MonthView component with framer-motion animations

**Features**:
- 6-week grid display (42 cells)
- Events grouped by date, sorted by all-day then start time
- Event chips colored by calendar source
- Prev/next month navigation with slide animation (300ms)
- Staggered fade-in for day cells (10ms stagger)
- Spring physics for event chips (stiffness: 400, damping: 25)
- Current day highlighted
- Loading skeleton state
- Accessible: keyboard navigation, aria-labels

**Files changed**:
- components/calendar/MonthView.tsx (new)
- components/calendar/MonthView.test.tsx (new, 10 tests)
- docs/prd.json (marked REQ-2-021, REQ-2-034, REQ-2-036 as completed)

**Verification**:
- typecheck: pass
- test: pass (113 tests total)
- lint: pass

## 2026-01-19: REQ-2-022 - Create week calendar view component

**Completed**: Created WeekView component with framer-motion animations

**Features**:
- 7-day view with hourly grid (60px per hour)
- All-day events in separate top section
- Timed events positioned by time + duration
- Current time indicator (red line)
- Prev/next week navigation with slide animation (300ms)
- Staggered reveal for events (50ms stagger)
- Auto-scroll to current hour on mount
- Loading skeleton state

**Files changed**:
- components/calendar/WeekView.tsx (new)
- components/calendar/WeekView.test.tsx (new, 10 tests)
- docs/prd.json (marked REQ-2-022 as completed)

**Verification**:
- typecheck: pass
- test: pass (123 tests total)
- lint: pass

## 2026-01-19: REQ-2-023 - Create day calendar view component

**Completed**: Created DayView component with framer-motion animations

**Features**:
- Single day view with hourly grid (80px per hour)
- All-day events in top section
- Timed events show title, time range, location
- Current time indicator with pulse animation
- Prev/next day navigation with slide animation (300ms)
- Spring physics for events (stiffness: 300, damping: 24)
- Auto-scroll to current hour on mount
- Loading skeleton state

**Files changed**:
- components/calendar/DayView.tsx (new)
- components/calendar/DayView.test.tsx (new, 12 tests)
- docs/prd.json (marked REQ-2-023 as completed)

**Verification**:
- typecheck: pass
- test: pass (135 tests total)
- lint: pass

## 2026-01-19: REQ-2-024 - Create calendar view page with view switcher

**Completed**: Created calendar view page with animated view switching

**Features**:
- View switcher: Month/Week/Day with hover animations
- View preference persisted to localStorage + URL params
- Today button jumps to current date
- Date picker dropdown for navigation
- Fetches events via /api/calendars/events endpoint
- Loading skeleton shimmer animation
- AnimatePresence for smooth view transitions
- Day click in month view switches to day view

**Files changed**:
- app/(dashboard)/calendars/view/page.tsx (new)
- app/api/calendars/events/route.ts (new)
- docs/prd.json (marked REQ-2-024 as completed)

**Verification**:
- typecheck: pass
- test: pass (135 tests total)
- lint: pass

## 2026-01-19: REQ-2-025 - Create event detail modal/panel

**Completed**: Created animated event detail modal with framer-motion

**Features**:
- Backdrop blur + fade animation
- Modal scale (0.95â†’1) + fade transition
- Shows title, time, location, description
- Shows calendar source name with color indicator
- Parses RRULE for human-readable recurrence display
- Close button + backdrop click + Escape key to dismiss
- Exit animation via AnimatePresence
- Full ARIA accessibility (dialog, modal, labelledby)

**Files changed**:
- components/calendar/EventDetail.tsx (new)
- components/calendar/EventDetail.test.tsx (new, 14 tests)
- app/(dashboard)/calendars/view/page.tsx (integrated EventDetail)
- docs/prd.json (marked REQ-2-025 as completed)

**Verification**:
- typecheck: pass
- test: pass (149 tests total)
- lint: pass

## 2026-01-19: REQ-2-012 - Create calendar selection page

**Completed**: Created calendar selection page with checkbox UI

**Features**:
- Fetches calendars via /api/calendars/sources endpoint
- Checkbox UI with staggered animation (50ms delay)
- Pre-selects already enabled calendars
- Select all / Deselect all controls
- Calendar color indicator
- Save button with loading state
- Cancel button to abort
- Empty state when no calendars
- Error handling with user-friendly messages
- Redirects to /calendars on success

**Files changed**:
- app/(dashboard)/calendars/connect/page.tsx (new)
- app/(dashboard)/calendars/connect/page.test.tsx (new, 11 tests)
- app/api/calendars/sources/route.ts (new - GET + PATCH)
- docs/prd.json (marked REQ-2-012 as completed)

**Verification**:
- typecheck: pass
- test: pass (160 tests total)
- lint: pass

## 2026-01-19: REQ-2-013 - Create calendars list page

**Completed**: Created calendars list page with management UI

**Features**:
- Lists all calendar_sources with name, color, provider badge
- Human-readable last synced time (e.g., "5m ago", "Never synced")
- Toggle switch to enable/disable calendars (optimistic update)
- Sync button per calendar with loading/success/error states
- Delete button with confirmation dialog
- Add Calendar button redirects to Google OAuth
- Empty state with call-to-action
- Error alerts for OAuth callback errors
- Link to calendar view page

**Files changed**:
- app/(dashboard)/calendars/page.tsx (new)
- app/(dashboard)/calendars/page.test.tsx (new, 11 tests)
- app/api/calendars/sources/route.ts (updated GET to support ?all=true)
- app/api/calendars/sources/[id]/route.ts (new - DELETE)
- docs/prd.json (marked REQ-2-013 as completed)

**Verification**:
- typecheck: pass
- test: pass (171 tests total)
- lint: pass

## 2026-01-19: REQ-2-031 - Create token refresh mechanism

**Completed**: Enhanced OAuth token refresh with revocation handling

**Features**:
- TokenRevocationError class for distinguishing permanent auth failures
- refreshAccessToken detects invalid_grant/revoked/expired tokens
- syncCalendarEvents catches TokenRevocationError
- markCalendarDisconnected clears tokens, sets enabled=false
- SyncResult includes disconnected flag

**Files changed**:
- lib/google/auth.ts (added TokenRevocationError, enhanced refreshAccessToken)
- lib/google/auth.test.ts (added tests for TokenRevocationError)
- lib/google/calendar.ts (import TokenRevocationError, markCalendarDisconnected)
- docs/prd.json (marked REQ-2-031, REQ-2-035, REQ-2-037 as completed)

**Notes**:
- REQ-2-035 (sync status indicator) already done in calendars page
- REQ-2-037 (empty state) already done in calendars page

**Verification**:
- typecheck: pass
- test: pass (173 tests total)
- lint: pass

## 2026-01-19: REQ-2-038 - Create error handling for Google API failures

**Completed**: Added comprehensive Google API error categorization

**Features**:
- GoogleApiErrorType: auth, not_found, rate_limit, server_error, network, unknown
- categorizeGoogleApiError: maps HTTP codes + message patterns to error types
- SyncResult: errorType, retryable flags for UI handling
- 404 errors auto-disconnect calendar (deleted on Google side)
- Network errors (ENOTFOUND, ECONNREFUSED, ETIMEDOUT) marked retryable
- 5xx server errors marked retryable
- Full error logged for debugging

**Files changed**:
- lib/google/calendar.ts (GoogleApiErrorType, categorizeGoogleApiError)
- lib/google/calendar.test.ts (+15 tests for error categorization)
- docs/prd.json (marked REQ-2-038 as completed)

**Verification**:
- typecheck: pass
- test: pass (188 tests total)
- lint: pass

## 2026-01-19: REQ-2-027-030 - Google Calendar webhook system

**Completed**: Full webhook push notification system

**Features**:
- webhook_channels table: stores channel_id, resource_id, expiration
- /api/webhooks/google: receives push notifications, triggers sync
- registerWebhookChannel: creates watch on calendar, 7-day expiration
- stopWebhookChannel/stopAllWebhookChannels: cleanup functions
- /api/cron/webhooks: daily job renews channels expiring in 24h
- vercel.json updated with daily cron

**Files created**:
- supabase/migrations/20260119210438_create_webhook_channels.sql
- app/api/webhooks/google/route.ts
- app/api/cron/webhooks/route.ts

**Files modified**:
- lib/google/calendar.ts (+registerWebhookChannel, +stopWebhookChannel, +stopAllWebhookChannels)
- vercel.json (added daily webhook cron)
- docs/prd.json (marked REQ-2-027,028,029,030 as completed)

**Verification**:
- typecheck: pass
- test: pass (188 tests total)
- lint: pass

## 2026-01-19: REQ-2-032 - Handle calendar disconnect

**Completed**: Calendar delete API now stops webhook channels

**Changes**:
- DELETE /api/calendars/sources/[id] calls stopAllWebhookChannels before delete
- Webhook cleanup is best-effort (logs warning but doesn't fail delete)
- All criteria already met: delete button, confirmation, cascade delete, success response

**Files changed**:
- app/api/calendars/sources/[id]/route.ts (added webhook cleanup)
- docs/prd.json (marked REQ-2-032 as completed)

**Verification**:
- typecheck: pass
- test: pass (188 tests total)
- lint: pass

## 2026-01-19: REQ-2-026 - Create calendar color picker component

**Completed**: Color picker dropdown with 16 predefined colors

**Features**:
- CALENDAR_COLORS: 16 distinct, accessible colors
- Trigger button shows current color
- Dropdown grid of color swatches
- Check icon on selected color
- Framer-motion animations (scale, fade)
- Full accessibility (listbox/option roles)
- PATCH /api/calendars/sources/[id] for color update

**Files created**:
- components/calendar/ColorPicker.tsx
- components/calendar/ColorPicker.test.tsx (10 tests)

**Files modified**:
- app/api/calendars/sources/[id]/route.ts (added PATCH handler)
- docs/prd.json (marked REQ-2-026 as completed)

**Verification**:
- typecheck: pass
- test: pass (198 tests total)
- lint: pass

## 2026-01-19: REQ-2-039 - Add calendar events to seed data

**Completed**: Created seed.sql with sample calendar data

**Contents**:
- Demo household + user
- 3 calendar_sources (Work, Family, Personal) with distinct colors
- Work events: standup, sprint planning, project review, workshop
- Family events: dinner, soccer tournament (all-day), vacation (multi-day)
- Personal events: gym, dentist, birthday (all-day)
- Uses current date calculations for realistic data

**Files created**:
- supabase/seed.sql

**Notes**:
- Requires Phase 1 migrations (households, users) to exist
- Uses ON CONFLICT DO NOTHING for idempotent re-runs

**Verification**:
- typecheck: pass
- test: pass (198 tests total)
- lint: pass

## 2026-01-19: Build Fix - Suspense boundaries for useSearchParams

**Completed**: Fixed Next.js build errors for useSearchParams without Suspense

**Changes**:
- app/(dashboard)/calendars/page.tsx: Added ErrorParamHandler component wrapped in Suspense
- app/(dashboard)/calendars/view/page.tsx: Refactored to CalendarViewContent with UrlParamsSyncer + useInitialParams hook, all wrapped in Suspense

**Notes**:
- Next.js requires useSearchParams to be wrapped in Suspense boundary for static page generation
- Extracted URL param logic into separate components that can be suspended

**Verification**:
- typecheck: pass
- test: pass (198 tests total)
- lint: pass
- build: pass

## Phase 2 Status Summary

**All automated requirements completed (39/40)**

**Remaining: REQ-2-040 - Manual verification of complete calendar sync flow**

This requirement cannot be completed automatically as it requires:
- Running npm run dev
- Real Google account with Google Cloud OAuth credentials configured
- Manual testing of the full OAuth flow, calendar selection, sync, and view

To complete manually:
1. Set up Google Cloud Console project with OAuth 2.0 credentials
2. Add credentials to .env.local (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI)
3. Run npm run dev and navigate to /calendars
4. Click "Add Calendar" to initiate OAuth
5. Complete Google consent and verify callback creates calendar_source
6. Select calendars on /calendars/connect page
7. Verify events appear on /calendars/view
8. Test view switching (month/week/day)
9. Test event detail modal
10. Test manual sync button

## 2026-01-20: Phase 3 Display Route - Core Infrastructure

**Completed**: Database migrations, types, components, and pages for display route

**Migrations created**:
- 20260120000000_create_displays.sql: displays table with auth_token, settings JSONB
- 20260120000100_displays_rls.sql: RLS policies + get_display_household_id() function
- 20260120000200_display_events_rls.sql: Allow displays to read household events

**Types/utilities created**:
- lib/display/types.ts: DisplaySettings interface, parseDisplaySettings, token generation
- lib/display/types.test.ts: 20 tests
- lib/display/time-formatting.ts: formatEventTime, isEventOngoing, formatClockTime, etc
- lib/display/time-formatting.test.ts: 22 tests
- lib/supabase/display.ts: createDisplayServerClient, createDisplayBrowserClient

**Components created** (components/display/):
- RealtimeProvider.tsx: Supabase realtime with exponential backoff reconnection
- DisplayContext.tsx: React context for display state management
- Clock.tsx: Large clock with 12/24h support
- DateTimeHeader.tsx: Header combining clock and household name
- TodayEvents.tsx: Animated list of today's events
- UpcomingEvents.tsx: Sidebar with 7-day lookahead
- Calendar.tsx: Main calendar display composition
- LoadingSkeleton.tsx: Shimmer loading state
- ErrorState.tsx: Error display with auto-retry
- OfflineIndicator.tsx: Network status indicator

**Pages created**:
- app/(display)/layout.tsx: Full-screen display layout (REQ-3-001)
- app/(display)/setup/page.tsx: Token validation and pairing (REQ-3-004)
- app/(display)/[displayId]/page.tsx: Server component for display data (REQ-3-005)
- app/(display)/[displayId]/DisplayClient.tsx: Client wrapper with realtime (REQ-3-005)
- app/(dashboard)/settings/displays/page.tsx: Display registration UI (REQ-3-003)

**API routes created**:
- app/api/displays/validate/route.ts: Validate display token
- app/api/displays/heartbeat/route.ts: Update last_seen_at (REQ-3-029)

**CSS additions** (globals.css):
- Display typography scale (.display-time, .display-date, .display-heading, etc)
- Theme transitions (500ms ease-in-out)
- Skeleton shimmer animation
- Ambient gradient animation (30s cycle)
- Burn-in prevention shift (180s cycle)
- Display grid layout

**Requirements completed**:
- REQ-3-001: Display route layout
- REQ-3-003: Display registration page
- REQ-3-004: Display setup/pairing
- REQ-3-005: Main display page
- REQ-3-006: Display calendar component
- REQ-3-007: Clock component
- REQ-3-008: Realtime provider
- REQ-3-009: Display data context
- REQ-3-010: Real-time event updates (via RealtimeProvider)
- REQ-3-011: Display settings schema
- REQ-3-017: Loading skeleton
- REQ-3-018: Error state
- REQ-3-019: Offline indicator
- REQ-3-020: Burn-in prevention CSS
- REQ-3-021: Date/time header
- REQ-3-022: Today's events list
- REQ-3-023: Upcoming events sidebar
- REQ-3-024: Event time formatting
- REQ-3-025: Display grid layout
- REQ-3-026: Display typography scale
- REQ-3-027: RLS policy for display access
- REQ-3-028: Supabase client for display
- REQ-3-029: Heartbeat mechanism
- REQ-3-033: Graceful reconnection (in RealtimeProvider)
- REQ-3-035: Ambient background animation

**Verification**:
- typecheck: pass
- test: pass (240 tests)
- lint: pass (1 warning in existing code)

## 2026-01-20: REQ-3-002 - Display device authentication

**Completed**: Page-level token authentication in [displayId]/page.tsx

**Notes**:
- Token validation implemented at page level rather than middleware
- All acceptance criteria satisfied:
  - Checks display_token cookie
  - Validates against displays.auth_token
  - Returns notFound() if invalid/missing
  - Updates last_seen_at on each request
  - Fetches household data

**Files**: app/(display)/[displayId]/page.tsx (already exists)

## 2026-01-20: REQ-3-012 - Display settings editor page

**Completed**: Created display settings editor UI

**Features**:
- Page at app/(dashboard)/settings/displays/[id]/page.tsx
- Edit display name
- Theme selector (light/dark/auto)
- Layout selector (calendar/agenda/split)
- Widget toggles (clock, upcoming events, weather placeholder)
- Time format selector (12h/24h)
- Scheduled reload time picker
- Visual effects toggles (burn-in prevention, ambient animation)
- Save button with loading state
- Success/error feedback

**Verification**:
- typecheck: pass
- lint: pass

## 2026-01-20: REQ-3-030 - QR code generator for display setup

**Completed**: Added QR code modal to displays page

**Features**:
- Installed qrcode.react library
- QR code button next to copy URL button
- Modal with QR code and setup URL
- Instructions for scanning with phone
- Animated modal open/close

**Files changed**:
- package.json (added qrcode.react)
- app/(dashboard)/settings/displays/page.tsx (added QR code modal)

**Verification**:
- typecheck: pass
- lint: pass

## 2026-01-20: REQ-3-031 - Token regeneration/invalidation

**Completed**: Added token regeneration feature to display settings page

**Features**:
- Security section showing current setup URL
- Copy URL button
- Regenerate Token button
- Confirmation modal warning about disconnection
- Immediate token update in database
- Display shows new setup URL after regeneration
- Success message with instructions

**Files changed**:
- app/(dashboard)/settings/displays/[id]/page.tsx (added security section)

**Verification**:
- typecheck: pass
- lint: pass

## 2026-01-20: REQ-3-013 - Theme support with smooth transitions

**Completed**: Added theme application from settings with CSS transitions

**Features**:
- useTheme hook in DisplayClient
- Applies theme class to document.documentElement
- Handles 'auto' by detecting system preference via matchMedia
- Listens for system preference changes when in auto mode
- CSS transitions already defined (500ms ease-in-out)
- Works with Tailwind dark mode classes

**Files changed**:
- app/(display)/[displayId]/DisplayClient.tsx (added useTheme hook)

**Verification**:
- typecheck: pass
- lint: pass

## 2026-01-20: REQ-3-014 + REQ-3-015 - Pi kiosk and watchdog scripts

**Completed**: Created Raspberry Pi deployment scripts

**scripts/pi-setup.sh features**:
- Takes display URL as argument
- Installs chromium-browser, unclutter, xdotool
- Disables screen blanking via xorg.conf
- Creates kiosk.sh launcher script with Chromium flags
- Configures autostart via .desktop file
- Sets up auto-login and startx
- Configures cron for watchdog (5-min) and daily reboot (3:30 AM)
- Includes troubleshooting tips

**scripts/pi-watchdog.sh features**:
- Checks if Chromium process is running
- Checks if Chromium window exists (xdotool)
- Monitors memory usage (restarts if >1.5GB)
- Logs all restart events with timestamps
- Log rotation when >1MB
- Designed for cron execution

**Verification**:
- typecheck: pass
- lint: pass
- Scripts are executable

## 2026-01-20: REQ-3-034 - Pi installation documentation

**Completed**: Created comprehensive Raspberry Pi setup guide

**File**: docs/raspberry-pi-setup.md

**Contents**:
- Hardware requirements (Pi 4 recommended, SD card, HDMI)
- Software requirements (Raspberry Pi OS, Chromium)
- Quick setup (3-step process using setup script)
- Manual setup alternative
- Troubleshooting section (black screen, invalid token, crashes, WiFi)
- Maintenance section (logs, updates, settings)
- Advanced config (resolution, portrait mode, multiple displays)
- Security notes

## 2026-01-20: REQ-3-032 - Debug overlay

**Completed**: Created hidden debug overlay for troubleshooting

**Features**:
- Toggle with Ctrl+D / Cmd+D
- Shows realtime connection status (connecting/connected/reconnecting/error)
- Shows display ID and household ID
- Shows last sync time and data counts (events, calendars)
- Shows memory usage (Chrome only, via performance.memory)
- Dismissible with Escape or Ctrl+D
- Semi-transparent dark panel in bottom-right corner

**Files created**:
- components/display/DebugOverlay.tsx

**Files modified**:
- app/(display)/[displayId]/DisplayClient.tsx (added DebugOverlay integration)

**Verification**:
- typecheck: pass
- lint: pass (1 pre-existing warning)

## 2026-01-20: Build Fix - Split display Supabase client for client/server separation

**Completed**: Fixed Next.js build error caused by mixing server-only imports in a file used by both client and server components

**Changes**:
- Split lib/supabase/display.ts into 3 files:
  - lib/supabase/display-constants.ts: Shared constants (DISPLAY_TOKEN_COOKIE, DISPLAY_TOKEN_HEADER)
  - lib/supabase/display-server.ts: Server-only functions with 'server-only' import
  - lib/supabase/display-client.ts: Client-side functions with 'use client' directive

**Files created**:
- lib/supabase/display-constants.ts
- lib/supabase/display-server.ts
- lib/supabase/display-client.ts

**Files modified**:
- components/display/RealtimeProvider.tsx (import from display-client)
- app/(display)/[displayId]/page.tsx (import from display-constants)
- app/(display)/setup/page.tsx (import from display-constants)
- app/api/displays/heartbeat/route.ts (import from display-constants)

**Files deleted**:
- lib/supabase/display.ts

**Verification**:
- typecheck: pass
- test: pass (240 tests)
- lint: pass (1 pre-existing warning)
- build: pass

## Phase 3 Status Summary

**All automated requirements completed (35/36)**

**Remaining: REQ-3-036 - Manual verification of complete display functionality**

This requirement cannot be completed automatically as it requires:
- Running npm run dev
- Manually registering a display in the dashboard
- Opening the setup URL in a browser (or Raspberry Pi)
- Verifying calendar data displays correctly
- Testing real-time updates
- Verifying animations and theme transitions

## 2026-01-20: REQ-5-001 to REQ-5-005 - Chores database schema

**Completed**: Created PostgreSQL migrations for chores system

**Migrations created**:
- 20260120100000_create_chores.sql: chores table (id, household_id, title, description, icon, points, created_at)
- 20260120100100_create_chore_assignments.sql: assignments table (id, chore_id, assigned_to, due_date, recurrence_rule, completed_at, created_at)
- 20260120100200_create_chore_assignments_index.sql: idx_chore_assignments_due (due_date, completed_at)
- 20260120100300_chores_rls.sql: RLS for chores (SELECT/INSERT/UPDATE/DELETE via get_user_household_id)
- 20260120100400_chore_assignments_rls.sql: RLS for assignments (joins through chores to check household)

**Decisions**:
- Followed existing pattern from calendar_sources/events RLS
- Assignments RLS uses EXISTS subquery to join through chores table
- Added indexes on chore_id and assigned_to for assignments table

**Verification**:
- typecheck: pass (cleared .next cache)
- test: pass (240 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: REQ-5-006, REQ-5-013 - rrule and recurrence utility

**Completed**: Installed rrule library and created recurrence expansion utility

**Dependencies**:
- rrule (bundled TypeScript types)

**Functions created** (lib/chores/recurrence.ts):
- generateRRule: create RRULE from RecurrenceConfig
- getNextOccurrences: expand rule to next N dates
- getNextOccurrence: get single next date
- parseRRuleToText: human-readable description
- parseRRuleToConfig: parse back to config object
- jsWeekdayToRRule/rruleWeekdayToJs: weekday conversions

**Files created**:
- lib/chores/recurrence.ts
- lib/chores/recurrence.test.ts (33 tests)

**Verification**:
- typecheck: pass
- test: pass (273 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: Chores API routes

**Completed**: Created full CRUD API for chores and assignments

**Routes created**:
- GET/POST /api/chores - list and create chores
- GET/PATCH/DELETE /api/chores/[id] - individual chore operations
- GET/POST /api/chores/assignments - list and create assignments
- GET/PATCH/DELETE /api/chores/assignments/[id] - individual assignment operations
- GET /api/household/members - list household members for assignment dropdowns

**Features**:
- GET /api/chores includes next upcoming assignment per chore
- Assignment PATCH auto-creates next occurrence when completing recurring chore (REQ-5-024)
- Assignments query supports user_id, from/to date, status filters
- All routes use RLS for household scoping

**Verification**:
- typecheck: pass
- test: pass (273 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: REQ-5-007 to REQ-5-011, REQ-5-015, REQ-5-022, REQ-5-024, REQ-5-030 - Chores UI

**Completed**: Full chores management UI with dashboard and detail pages

**Pages created**:
- app/(dashboard)/chores/page.tsx: Main chores list with add button, empty state
- app/(dashboard)/chores/[id]/page.tsx: Chore detail with edit, delete, assignments

**Features**:
- Chores list with icon, title, points, next assignment info
- Chore cards show overdue status with red left border
- Create chore modal (title, description, emoji icon, points)
- Edit chore modal with pre-filled data
- Delete with confirmation dialog (cascade deletes assignments)
- Assignment creation with assignee dropdown, due date, recurrence type
- Assignment completion toggle (checkbox)
- Recurring auto-creation on completion (via API)
- Empty state with suggestions and CTA
- Framer Motion animations throughout

**Requirements completed**: 5-007, 5-008, 5-009, 5-010, 5-011, 5-015, 5-022, 5-024, 5-030

**Verification**:
- typecheck: pass
- test: pass (273 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: REQ-5-018, REQ-5-019, REQ-5-020, REQ-5-031 - Chores display integration

**Completed**: Integrated chores into the Pi wall display with realtime updates

**REQ-5-018: Display chore list component**:
- Created components/display/ChoreList.tsx
- Shows today's, overdue, and upcoming chores
- Visual status indicators (overdue=red, today=primary, upcoming=gray)
- User initials avatar for assignees
- Points badges for incomplete chores
- Smooth framer-motion animations

**REQ-5-019: Display layout integration**:
- Added chores widget toggle to DisplayWidgets type
- Updated display grid layout with chores area
- Chores positioned below sidebar in right column
- ChoreList receives assignments from DisplayContext
- Toggleable via settings.widgetsEnabled.chores

**REQ-5-020: Realtime subscription**:
- Added chore_assignments subscription to RealtimeProvider
- ChoreAssignmentRecord type for database row
- Handle INSERT (triggers timestamp refresh)
- Handle UPDATE (preserves chore/user data from existing state)
- Handle DELETE (removes by ID)
- DisplayContext actions for ADD/UPDATE/DELETE

**REQ-5-031: Seed data**:
- 9 sample chores with icons and points
- Second user (Alex) for assignment variety
- 10 sample assignments with various states:
  - 2 overdue (dishes yesterday, bathroom 3 days ago)
  - 3 today (trash, dog feed completed, dishes)
  - 2 tomorrow (vacuum, laundry unassigned)
  - 1 day after (clean kitchen)
  - 1 weekend (mow lawn)
  - 1 next week (dust furniture)
- Various recurrence patterns: daily, weekly, biweekly

**Files created**:
- components/display/ChoreList.tsx

**Files modified**:
- lib/display/types.ts (added chores to DisplayWidgets)
- lib/display/types.test.ts (updated tests for chores widget)
- components/display/DisplayContext.tsx (ChoreAssignment type, actions, handlers)
- components/display/RealtimeProvider.tsx (chore_assignments subscription)
- components/display/Calendar.tsx (added ChoreList import and rendering)
- app/(display)/[displayId]/page.tsx (fetch chore assignments)
- app/(display)/[displayId]/DisplayClient.tsx (pass chore handlers)
- app/globals.css (display-chores grid area)
- supabase/seed.sql (chores and assignments seed data)
- docs/prd.json (marked 4 requirements completed)

**Verification**:
- typecheck: pass
- test: pass (273 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: REQ-5-012 - Create recurrence selector component

**Completed**: Full-featured recurrence selector with RRULE integration

**Features**:
- Controlled component deriving state from value prop
- Dropdown: None, Daily, Weekly, Biweekly, Monthly
- Weekly: 7 day-of-week buttons (Mon-Sun)
- Monthly: 31 day-of-month buttons (1-31)
- Expandable "Customize schedule" toggle
- Generates RRULE via lib/chores/recurrence.ts
- Parses existing RRULE for editing
- Human-readable preview text
- Framer Motion animations

**Files created**:
- components/chores/RecurrenceSelector.tsx
- components/chores/RecurrenceSelector.test.tsx (14 tests)

**Files modified**:
- app/(dashboard)/chores/[id]/page.tsx (AssignModal uses RecurrenceSelector)
- docs/prd.json (marked REQ-5-012 completed)

**Verification**:
- typecheck: pass
- test: pass (287 tests)
- lint: pass (1 pre-existing warning)

## 2026-01-20: REQ-5-028 - Create family member avatars

**Completed**: Reusable UserAvatar component with image and initials fallback

**Features**:
- Displays avatar image via Next.js Image if avatarUrl provided
- Falls back to initials (first+last or first 2 chars)
- Consistent color generation based on name (16 colors)
- 5 sizes: xs (24px), sm (32px), md (40px), lg (48px), xl (64px)
- Optional bordered variant for avatar groups
- AvatarGroup component with +N overflow indicator
- Image error handling falls back to initials

**Files created**:
- components/ui/UserAvatar.tsx
- components/ui/UserAvatar.test.tsx (18 tests)

**Files modified**:
- components/display/ChoreList.tsx (uses UserAvatar instead of local UserInitials)
- app/(dashboard)/chores/[id]/page.tsx (shows avatar next to assignee name)
- docs/prd.json (marked REQ-5-028 completed)

**Verification**:
- typecheck: pass
- test: pass (305 tests)
- lint: pass (1 pre-existing warning)