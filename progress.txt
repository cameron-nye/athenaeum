# Progress Log

## 2026-01-19: REQ-1-002 - Install Supabase dependencies

**Completed**: Installed @supabase/supabase-js, @supabase/ssr (runtime deps), supabase CLI (devDep)

**Decisions**:
- Used npm (not pnpm) to match existing project setup

**Files changed**:
- package.json (added dependencies)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-1-003 - Install Framer Motion

**Completed**: Installed framer-motion v12.27.0 for smooth animations

**Files changed**:
- package.json (added framer-motion)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-003 - Create calendar_sources table migration

**Completed**: Created PostgreSQL migration for calendar_sources table

**Decisions**:
- References households(id) and users(id) - requires Phase 1 migrations to run first
- Added CHECK constraint for provider ('google', 'ical')
- Added UNIQUE constraint on (household_id, provider, external_id)
- Added indexes for household lookup and sync queries
- Included encrypted token columns for OAuth security

**Files changed**:
- supabase/migrations/20260119080810_create_calendar_sources.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-004 - Create events table migration

**Completed**: Created PostgreSQL migration for events table

**Decisions**:
- References calendar_sources(id) ON DELETE CASCADE
- UNIQUE constraint on (calendar_source_id, external_id)
- all_day defaults to false
- raw_data stored as JSONB for provider debugging
- updated_at column for tracking modifications

**Files changed**:
- supabase/migrations/20260119090000_create_events.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-005 - Create events table indexes

**Completed**: Created performance indexes for events table

**Decisions**:
- idx_events_calendar_time: composite index on (calendar_source_id, start_time) for calendar queries
- idx_events_time_range: composite index on (start_time, end_time) for date range queries

**Files changed**:
- supabase/migrations/20260119100000_create_events_indexes.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-006 - Create RLS policies for calendar_sources table

**Completed**: Created RLS policies for calendar_sources

**Decisions**:
- Uses get_user_household_id() helper (from Phase 1) for household scoping
- SELECT/INSERT/UPDATE/DELETE all scoped to user's household
- Follows same pattern as Phase 1 RLS policies

**Files changed**:
- supabase/migrations/20260119110000_calendar_sources_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-007 - Create RLS policies for events table

**Completed**: Created RLS policies for events table

**Decisions**:
- Joins through calendar_sources to check household membership
- Uses EXISTS subquery pattern for security
- SELECT/INSERT/UPDATE/DELETE all check calendar_source->household relation
- UPDATE uses both USING and WITH CHECK to prevent changing calendar_source_id to other household

**Files changed**:
- supabase/migrations/20260119120000_events_rls.sql (new)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-001 - Install Google API dependencies

**Completed**: Installed googleapis v170.1.0 for Google Calendar API access

**Decisions**:
- googleapis includes bundled TypeScript types (no separate @types needed)

**Files changed**:
- package.json (added googleapis)
- package-lock.json (updated)

**Verification**:
- typecheck: pass
- test: pass
- lint: pass

## 2026-01-19: REQ-2-009 - Create token encryption utility

**Completed**: Created AES-256-GCM encryption for OAuth tokens

**Decisions**:
- Created lib/crypto.ts (not src/lib) to match existing codebase structure
- Uses Node.js crypto module (no deps needed)
- AES-256-GCM with scrypt key derivation
- Random salt + IV per encryption for security
- Base64 encoding for storage: salt + iv + authTag + ciphertext
- Requires ENCRYPTION_KEY env var

**Files changed**:
- lib/crypto.ts (new)
- lib/crypto.test.ts (new)

**Verification**:
- typecheck: pass
- test: pass (11 tests)
- lint: pass